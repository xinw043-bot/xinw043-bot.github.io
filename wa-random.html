<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Connect on WhatsApp</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 45px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            max-width: 360px;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
        }
        
        .icon-img {
            width: 72px;
            height: 72px;
            margin-bottom: 30px;
            filter: drop-shadow(0 4px 8px rgba(37, 211, 102, 0.2));
            border-radius: 18px;
        }
        
        h2 { display: none; }
        
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 16px 0;
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            border: none;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.1s, opacity 0.2s;
            line-height: 1.2;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        .btn-primary { background-color: #25D366; }
        .btn-copy { background-color: #0084ff; margin-bottom: 0; }
        
        .loading { font-size: 14px; color: #888; margin-top: 10px; }
        
        /* 提示语样式 */
        .ios-hint-text {
            font-size: 13px; color: #d93025; background-color: #fff8f8;
            padding: 12px; border-radius: 8px; margin-top: 20px;
            line-height: 1.4; text-align: left; display: none; border: 1px solid #ffebeb;
        }

        /* ID 显示区域 */
        .ref-id-box {
            margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee;
            font-size: 12px; color: #999; font-family: sans-serif;
            letter-spacing: 0.5px; font-style: italic;
            cursor: pointer; position: relative;
        }
        .ref-id-text { color: #666; font-weight: normal; user-select: all; }

        #id-copy-tip {
            position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px;
            border-radius: 4px; font-size: 10px; display: none;
            font-family: sans-serif; font-style: normal; white-space: nowrap;
        }
    </style>
</head>
<body>

    <div class="container">
        <img class="icon-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMyAzMyIgZmlsbD0ibm9uZSI+PHBhdGggZD0iTTE2LjYgMEM3LjQgMCAwIDcuNSAwIDE2LjdjMCAzIC44IDUuOSAyLjMgOC40TC42IDMzbDguMS0yLjFjMi40IDEuNCA1LjEgMi4xIDggMi4xIDkuMSAwIDE2LjUtNy41IDE2LjUtMTYuN1MyNS43IDAgMTYuNiAwem0wIDI3LjhjLTIuNiAwLTUuMS0uNy03LjMtMmwtLjUtLjMtNS40IDEuNCAxLjQtNS4zLS4zLS41QzMuMSAxOC44IDIuNCAxNi4zIDIuNCAxMy44YzAtNy44IDYuNC0xNC4yIDE0LjItMTQuMiAzLjggMCA3LjQgMS41IDEwIDQuMiAyLjcgMi43IDQuMiA2LjMgNC4yIDEwIDAgNy45LTYuMyAxNC4yLTE0LjIgMTR6bTcuOC0xMC40Yy0uNC0uMi0yLjUtMS4yLTIuOS0xLjQtLjQtLjItLjYtLjMtLjkuMS0uMy40LTEuMSAxLjQtMS4zIDEuNy0uMi4zLS41LS4xLS45LjEtMS44LS45LTMtMS42LTQuMi0zLjctLjYtMS4xLjYtMSAuMS0yLS4xLS4yLS4yLS40LS4zLS42LS4xLS4yLS4xLS40IDAtLjYuMS0uMi40LS45LjYtMS4zLjEtLjIgMC0uNC0uMS0uNS0uMS0uMi0uOS0yLjItMS4zLTMtLjQtLjgtLjctLjctMS0uN2gtLjhjLS4zIDAtLjcuMS0xLjEuNS0uNC40LTEuNSAxLjUtMS41IDMuNiAwIDIuMiAxLjYgNC4zIDEuOCA0LjYuMi4zIDMuMSA0LjcgNy42IDYuNiAyLjcgMS4xIDMuOCAxLjEgNS4yLjkgMS42LS4yIDMuNS0xLjQgNC0yLjguNS0xLjMuNS0yLjUuMy0yLjctLjEtLjItLjQtLjMtLjgtLjV6IiBmaWxsPSIjMjVkMzY2Ii8+PC9zdmc+" alt="WhatsApp">

        <a id="wa-link" href="#" target="_blank" class="btn btn-primary">Open WhatsApp</a>
        
        <button id="copy-btn" class="btn btn-copy" style="display:none;" onclick="copyNumber()">
            Copy Sales WhatsApp
        </button>
        
        <!-- 这里是提示语容器 -->
        <div id="ios-hint" class="ios-hint-text"></div>

        <div id="loading-text" class="loading">Redirecting...</div>

        <!-- 底部 ID 显示 -->
        <div class="ref-id-box" onclick="copyId()" title="Tap to copy">
            <span id="id-copy-tip">Copied!</span>
            INQUIRY ID : <span id="ref-id-span" class="ref-id-text">...</span>
        </div>
    </div>

    <script>
    const ruNumbers = ["8613831115956", "8615580779722"];
    const esNumbers = ["8613890174417", "8619994654895", "8618923713151"]; 
    const arNumbers = ["8613890174417", "8619994654895", "8618923713151"]; 
    const defaultNumbers = ["8613890174417", "8619994654895", "8618923713151"];
    
    const apiUrl = "https://xinw043-bot-github-io.vercel.app/api/log"; 

    // --- 语言包升级：文案大一统 ---
    // hintFallback 现在和 hint 完全一致，确保体验统一
    const translations = {
        'en': {
            openBtn: "Open WhatsApp", copyBtn: "Copy Sales WhatsApp",
            // 统一文案：如果打不开，请复制号码和ID
            hint: "If WhatsApp fails to open:<br>1. Copy sales number (Blue Button).<br>2. <b>Tap the ID below to copy</b> & send to us.",
            hintFallback: "If WhatsApp fails to open:<br>1. Copy sales number (Blue Button).<br>2. <b>Tap the ID below to copy</b> & send to us.",
            loading: "Redirecting...", copied: "Copied! ✅",
            message: "Hi, I want to inquire about thermal imaging cameras",
            msgWarning: "(Do not delete)"
        },
        'ru': {
            openBtn: "Открыть WhatsApp", copyBtn: "Скопировать номер",
            hint: "Если не открывается:<br>1. Скопируйте номер выше.<br>2. <b>Нажмите на ID ниже</b>, скопируйте и пришлите нам.",
            hintFallback: "Если не открывается:<br>1. Скопируйте номер выше.<br>2. <b>Нажмите на ID ниже</b>, скопируйте и пришлите нам.",
            loading: "Перенаправление...", copied: "Скопировано! ✅",
            message: "Здравствуйте, я хочу узнать о тепловизионных камерах",
            msgWarning: "(Не удалять)"
        },
        'es': {
            openBtn: "Abrir WhatsApp", copyBtn: "Copiar WhatsApp",
            hint: "Si no abre:<br>1. Copie el número (Botón Azul).<br>2. <b>Toque el ID abajo</b> para copiar y envíenoslo.",
            hintFallback: "Si no abre:<br>1. Copie el número (Botón Azul).<br>2. <b>Toque el ID abajo</b> para copiar y envíenoslo.",
            loading: "Redirigiendo...", copied: "¡Copiado! ✅",
            message: "Hola, quiero consultar sobre cámaras termográficas",
            msgWarning: "(No borrar)"
        },
        'ar': {
            openBtn: "فتح واتساب", copyBtn: "نسخ رقم واتساب",
            hint: "إذا لم يفتح:<br>1. انسخ الرقم (الزر الأزرق).<br>2. <b>اضغط على المعرف أدناه لنسخه</b> وأرسله إلينا.",
            hintFallback: "إذا لم يفتح:<br>1. انسخ الرقم (الزر الأزرق).<br>2. <b>اضغط على المعرف أدناه لنسخه</b> وأرسله إلينا.",
            loading: "جاري التوجيه...", copied: "تم النسخ! ✅",
            message: "مرحبًا، أريد الاستفسار عن الكاميرات الحرارية",
            msgWarning: "(لا تحذف)"
        }
    };

    function generateInquiryId() {
        let id = localStorage.getItem('wa_inquiry_id');
        if (!id) {
            const timePart = Date.now().toString().slice(-4); 
            const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
            id = `REF-${timePart}${randomPart}`;
            localStorage.setItem('wa_inquiry_id', id);
        }
        return id;
    }

    const userLang = (navigator.language || navigator.userLanguage || 'en').substring(0, 2).toLowerCase();
    let currentLang = 'en'; 
    let currentPool = defaultNumbers;

    if (translations[userLang]) {
        currentLang = userLang;
        if (userLang === 'ru') currentPool = ruNumbers;
        else if (userLang === 'es') currentPool = esNumbers;
        else if (userLang === 'ar') currentPool = arNumbers;
    }

    const t = translations[currentLang];

    if (currentLang === 'ar') {
        document.body.setAttribute('dir', 'rtl');
        document.querySelector('.ios-hint-text').style.textAlign = 'right';
    }

    let finalNumber = localStorage.getItem('assigned_wa');
    if (!finalNumber || !currentPool.includes(finalNumber)) {
        finalNumber = currentPool[Math.floor(Math.random() * currentPool.length)];
        localStorage.setItem('assigned_wa', finalNumber);
    }

    const inquiryId = generateInquiryId();
    document.getElementById('ref-id-span').innerText = inquiryId;

    document.getElementById('wa-link').innerText = t.openBtn;
    document.getElementById('copy-btn').innerText = t.copyBtn;
    document.getElementById('ios-hint').innerHTML = t.hint;
    document.getElementById('loading-text').innerText = t.loading;

    window.onload = function() {
        const logData = { 
            phoneNumber: finalNumber, 
            redirectTime: new Date().toISOString(),
            language: userLang,
            inquiryId: inquiryId 
        };
        fetch(apiUrl, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(logData), keepalive: true 
        }).catch(console.error);

        const spacer = "\n\n"; 
        const idFormat = "─────\n_" + "INQUIRY ID : " + inquiryId + " " + t.msgWarning + "_";
        const finalMessageText = `${t.message}${spacer}${idFormat}`; 
        const encodedMessage = encodeURIComponent(finalMessageText);
        
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        
        const androidLink = `whatsapp://send?phone=${finalNumber}&text=${encodedMessage}`;
        const iosLink = `https://api.whatsapp.com/send?phone=${finalNumber}&text=${encodedMessage}`; 
        const targetLink = isAndroid ? androidLink : iosLink;

        const linkBtn = document.getElementById('wa-link');
        linkBtn.href = targetLink;

        const loadingText = document.getElementById('loading-text');
        const copyBtn = document.getElementById('copy-btn');
        const iosHint = document.getElementById('ios-hint');

        if (isIOS) {
            // 场景 1: iOS
            loadingText.style.display = 'none';
            copyBtn.style.display = 'flex';
            iosHint.innerHTML = t.hint; // 使用标准文案
            iosHint.style.display = 'block';
        } else {
            // 场景 2: 安卓/PC
            
            // A. 尝试自动跳转
            setTimeout(() => { 
                // 记得测试完把这两条斜杠去掉 ↓
                window.location.href = targetLink; 
            }, 1000);

            // B. 失败兜底
            setTimeout(() => {
                loadingText.style.display = 'none';
                copyBtn.style.display = 'flex'; 
                iosHint.innerHTML = t.hintFallback; // 使用相同的标准文案
                iosHint.style.display = 'block'; 
            }, 2500);
        }
    };

    function copyNumber() {
        const tempInput = document.createElement("input");
        tempInput.value = "+" + finalNumber;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        
        const btn = document.getElementById('copy-btn');
        const originalText = btn.innerText;
        btn.innerText = t.copied; 
        btn.style.backgroundColor = "#128C7E"; 
        
        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.backgroundColor = "#0084ff";
        }, 2000);
    }

    function copyId() {
        const tempInput = document.createElement("input");
        tempInput.value = "INQUIRY ID : " + inquiryId + " " + t.msgWarning;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);

        const tip = document.getElementById('id-copy-tip');
        tip.style.display = 'block';
        setTimeout(() => {
            tip.style.display = 'none';
        }, 1500);
    }
    </script>
</body>
</html>
