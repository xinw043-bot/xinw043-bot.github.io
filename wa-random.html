<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Connect on WhatsApp</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        .container {
            background: white;
            padding: 30px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }
        h2 { color: #333; margin-bottom: 10px; font-size: 22px; }
        p { color: #666; margin-bottom: 25px; font-size: 16px; line-height: 1.5; }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px 0;
            background-color: #25D366;
            color: white;
            text-decoration: none;
            font-weight: bold;
            font-size: 18px;
            border-radius: 30px;
            transition: opacity 0.3s;
            box-sizing: border-box;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .btn:active { opacity: 0.8; transform: scale(0.98); }
        
        .loading { font-size: 13px; color: #999; margin-top: 20px; min-height: 20px; }
        
        /* 针对 iOS 无法跳转时的备用提示 */
        .safari-hint {
            margin-top: 20px;
            font-size: 12px;
            color: #888;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
            display: none; /* 默认隐藏 */
        }
    </style>
</head>
<body>

    <div class="container">
        <svg width="60" height="60" viewBox="0 0 24 24" fill="#25D366" xmlns="http://www.w3.org/2000/svg">
            <path d="M17.472 14.382C17.112 14.202 15.344 13.332 15.013 13.213C14.682 13.094 14.441 13.034 14.2 13.394C13.959 13.754 13.269 14.564 13.058 14.804C12.848 15.044 12.638 15.074 12.278 14.894C11.918 14.714 10.758 14.334 9.383 13.109C8.308 12.15 7.583 10.966 7.373 10.606C7.163 10.246 7.35 10.051 7.53 9.871C7.69 9.711 7.886 9.455 8.066 9.245C8.246 9.035 8.306 8.885 8.426 8.645C8.546 8.405 8.486 8.195 8.411 8.045C8.336 7.895 7.646 6.196 7.361 5.506C7.081 4.832 6.796 4.922 6.586 4.922C6.391 4.922 6.166 4.907 5.941 4.907C5.716 4.907 5.356 4.997 5.056 5.327C4.756 5.657 3.9 6.467 3.9 8.117C3.9 9.767 5.101 11.372 5.281 11.612C5.461 11.852 7.771 15.418 11.311 16.948C12.152 17.308 12.809 17.524 13.323 17.687C14.167 17.955 14.937 17.917 15.545 17.826C16.219 17.726 17.622 16.976 17.914 16.151C18.206 15.326 18.206 14.621 18.116 14.471C18.026 14.321 17.786 14.261 17.426 14.081H17.472Z" fill="white"/>
        </svg>

        <h2>Chat on WhatsApp</h2>
        <p id="status-text">Click the button below to start chat</p>
        
        <!-- 核心修改：target="_blank" 是解决 iOS 页面损坏的关键 -->
        <a id="wa-link" href="#" target="_blank" class="btn">Open WhatsApp</a>
        
        <div id="loading-text" class="loading">Secure connection...</div>

        <!-- 备用方案提示 -->
        <div id="safari-hint" class="safari-hint">
            Button not working?<br>
            Tap the <b>•••</b> icon at top-right and select<br>
            <b>"Open in Safari"</b> or <b>"Open in Browser"</b>.
        </div>
    </div>

    <script>
    const waNumbers = ["8613890174417", "8619994654895", "8618923713151"];
    const apiUrl = "https://xinw043-bot-github-io.vercel.app/api/log"; 

    // 锁定号码
    let finalNumber = localStorage.getItem('assigned_wa');
    if (!finalNumber) {
        finalNumber = waNumbers[Math.floor(Math.random() * waNumbers.length)];
        localStorage.setItem('assigned_wa', finalNumber);
    }

    const message = encodeURIComponent("Hi I want to inquire about thermal imaging cameras");
    
    // 环境检测
    const ua = navigator.userAgent;
    const isAndroid = /Android/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    
    // 链接策略
    let targetLink;
    if (isAndroid) {
        // 安卓：Deep Link
        targetLink = `whatsapp://send?phone=${finalNumber}&text=${message}`;
    } else {
        // iOS/PC：使用标准 API 链接
        // 配合 target="_blank" 可解决 Messenger 报错
        targetLink = `https://api.whatsapp.com/send?phone=${finalNumber}&text=${message}`;
    }

    // 绑定按钮
    const btn = document.getElementById('wa-link');
    btn.href = targetLink;

    window.onload = function() {
        // 发送日志
        const logData = {
            phoneNumber: finalNumber,
            redirectTime: new Date().toISOString()
        };
        fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(logData),
            keepalive: true 
        }).catch(console.error);

        // --- 跳转逻辑 ---
        const statusText = document.getElementById('status-text');
        const loadingText = document.getElementById('loading-text');
        const safariHint = document.getElementById('safari-hint');

        if (isIOS) {
            // iOS：不自动跳转，只显示提示
            loadingText.style.display = 'none';
            statusText.innerText = "Please tap the button below.";
            // 在 iOS Messenger 中显示备用操作提示
            if (ua.includes("FBAN") || ua.includes("FBAV")) {
                safariHint.style.display = 'block';
            }
        } else {
            // 安卓/PC：尝试自动跳转
            loadingText.innerText = "Redirecting...";
            setTimeout(() => {
                // 如果是安卓，尝试点击按钮触发 Deep Link
                if(isAndroid) {
                    btn.click();
                } else {
                    window.location.href = targetLink;
                }
            }, 1000);
        }
    };
    </script>
</body>
</html>
