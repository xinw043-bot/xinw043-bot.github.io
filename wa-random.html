<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        /* 模仿 WhatsApp 原生风格 */
        .icon-box {
            margin-bottom: 20px;
        }
        h2 { color: #111b21; margin-bottom: 10px; font-size: 20px; font-weight: 600;}
        p { color: #54656f; margin-bottom: 30px; font-size: 15px; }
        
        .btn {
            display: block;
            width: 100%;
            padding: 14px 0;
            background-color: #00a884;
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            border-radius: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn:active { background-color: #008f6f; }
        
        /* 底部辅助链接 */
        .sub-link {
            margin-top: 20px;
            font-size: 13px;
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            background: none;
            border: none;
            padding: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="icon-box">
             <svg viewBox="0 0 33 33" width="60" height="60" class="" xmlns="http://www.w3.org/2000/svg"><path d="M16.6 0C7.4 0 0 7.5 0 16.7c0 3 .8 5.9 2.3 8.4L.6 33l8.1-2.1c2.4 1.4 5.1 2.1 8 2.1 9.1 0 16.5-7.5 16.5-16.7S25.7 0 16.6 0zm0 27.8c-2.6 0-5.1-.7-7.3-2l-.5-.3-5.4 1.4 1.4-5.3-.3-.5C3.1 18.8 2.4 16.3 2.4 13.8c0-7.8 6.4-14.2 14.2-14.2 3.8 0 7.4 1.5 10 4.2 2.7 2.7 4.2 6.3 4.2 10 0 7.9-6.3 14-14.2 14zm7.8-10.4c-.4-.2-2.5-1.2-2.9-1.4-.4-.2-.6-.3-.9.1-.3.4-1.1 1.4-1.3 1.7-.2.3-.5.3-.9.1-1.8-.9-3-1.6-4.2-3.7-.6-1.1.6-1 .1-2-.1-.2-.2-.4-.3-.6-.1-.2-.1-.4 0-.6.1-.2.4-.9.6-1.3.1-.2 0-.4-.1-.5-.1-.2-.9-2.2-1.3-3-.4-.8-.7-.7-1-.7h-.8c-.3 0-.7.1-1.1.5-.4.4-1.5 1.5-1.5 3.6 0 2.2 1.6 4.3 1.8 4.6.2.3 3.1 4.7 7.6 6.6 2.7 1.1 3.8 1.1 5.2.9 1.6-.2 3.5-1.4 4-2.8.5-1.3.5-2.5.3-2.7-.1-.2-.4-.3-.8-.5z" fill="#00a884" fill-rule="evenodd"></path></svg>
        </div>

        <h2>Chat on WhatsApp</h2>
        <p id="desc-text">Continue to chat on WhatsApp</p>
        
        <!-- 
           关键修改：
           1. iOS 上使用 api.whatsapp.com (最稳)
           2. 必须加 target="_blank" (触发新窗口)
           3. 必须加 rel="noopener" (防拦截)
        -->
        <a id="wa-link" href="#" target="_blank" rel="noopener" class="btn">Continue</a>
        
        <!-- 备选：强制 Web 版 -->
        <div id="backup-box" style="display:none; margin-top:15px;">
            <p style="font-size:12px; margin-bottom:5px;">Having trouble?</p>
            <a id="backup-link" href="#" target="_blank" style="font-size:14px; color:#666;">Try Web Version</a>
        </div>
    </div>

    <script>
    const waNumbers = ["8613890174417", "8619994654895", "8618923713151"];
    const apiUrl = "https://xinw043-bot-github-io.vercel.app/api/log"; 

    // 锁定号码
    let finalNumber = localStorage.getItem('assigned_wa');
    if (!finalNumber) {
        finalNumber = waNumbers[Math.floor(Math.random() * waNumbers.length)];
        localStorage.setItem('assigned_wa', finalNumber);
    }

    const message = encodeURIComponent("Hi I want to inquire about thermal imaging cameras");
    
    // 环境检测
    const ua = navigator.userAgent;
    const isAndroid = /Android/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    
    // 生成链接
    // Android 用协议，iOS 用 https (wa.me 在 Messenger 里有时比 api.whatsapp.com 更好，我们再试一次 wa.me)
    const androidLink = `whatsapp://send?phone=${finalNumber}&text=${message}`;
    const iosLink = `https://api.whatsapp.com/send?phone=${finalNumber}&text=${message}`; 
    
    const targetLink = isAndroid ? androidLink : iosLink;

    // 绑定主按钮
    const btn = document.getElementById('wa-link');
    btn.href = targetLink;
    
    // 绑定点击事件：只负责发日志，绝对不干扰跳转
    btn.onclick = function() {
        // 1. 发日志 (异步)
        const logData = { phoneNumber: finalNumber, redirectTime: new Date().toISOString() };
        fetch(apiUrl, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(logData), keepalive: true 
        }).catch(console.error);

        // 2. 如果是 iOS，我们什么都不做，让 <a target="_blank"> 自己发挥
        // 3. 如果是 Android，我们可以尝试手动 click 确保触发
        if (isAndroid) return true;
    };

    // 自动跳转逻辑
    window.onload = function() {
        if (isAndroid) {
            // Android 依然自动跳，因为体验好
            setTimeout(() => { window.location.href = targetLink; }, 1000);
        } else {
            // iOS: 啥也不干，就等着用户点按钮
            // 这是避免报错的唯一方法
            // 如果 3秒后用户没点，我们可以显示备用链接
            setTimeout(() => {
                document.getElementById('backup-box').style.display = 'block';
                document.getElementById('backup-link').href = targetLink;
            }, 3000);
        }
    };
    </script>
</body>
</html>
